version: 0.1

env:
  secrets-manager:
    LOGIN: code-pipeline-sonarqube-cloud-demo:sornatoken
    HOST: code-pipeline-sonarqube-cloud-demo:HOST
    Organization: code-pipeline-sonarqube-cloud-demo:Organization
    Project: code-pipeline-sonarqube-cloud-demo:Project
phases:
  pre_build:
    commands:
      - mvn sonar:sonar -Dsonar.login=$LOGIN -Dsonar.host.url=$HOST -Dsonar.projectKey=$Project -Dsonar.organization=$Organization -Dmaven.wagon.http.ssl.insecure=true -Dmaven.wagon.http.ssl.allowall=true -Dmaven.wagon.http.ssl.ignore.validity.dates=true
      - sleep 5
      - curl https://sonarcloud.io/api/qualitygates/project_status?projectKey=$Project >result.json
  build:
    commands:
      - mvn test
  post_build:
    commands:
      - mvn package -DskipTests=true
artifacts:
  files:
    - target/pipeline-demo-0.0.1-SNAPSHOT.jar